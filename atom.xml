<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>寒冬的腊梅</title>
  
  <subtitle>风雨百年6462</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://blog.520xnc.cn/"/>
  <updated>2019-02-25T08:13:16.858Z</updated>
  <id>https://blog.520xnc.cn/</id>
  
  <author>
    <name>xuecx</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>cat3.0安装配置集成springboot+mybatis</title>
    <link href="https://blog.520xnc.cn/2019/02/25/20190225154619/"/>
    <id>https://blog.520xnc.cn/2019/02/25/20190225154619/</id>
    <published>2019-02-25T07:46:19.000Z</published>
    <updated>2019-02-25T08:13:16.858Z</updated>
    
    <content type="html"><![CDATA[<h4 id="一、环境清单"><a href="#一、环境清单" class="headerlink" title="一、环境清单"></a>一、环境清单</h4><p>CentOS 7、mysql5.6、安装jdk8、安装maven3以上、安装tomcat8、安装git</p><h4 id="二、cat服务器端安装"><a href="#二、cat服务器端安装" class="headerlink" title="二、cat服务器端安装"></a>二、cat服务器端安装</h4><p>1、下载源码<br>原来下载主要会用到里面的一些资料</p><blockquote><p>a、数据库脚本；<br>  b、客户端包cat_client.jar；</p></blockquote><p>gitee</p><blockquote><p>git clone <a href="https://gitee.com/mirrors/CAT.git" target="_blank" rel="noopener">https://gitee.com/mirrors/CAT.git</a> （国内镜像速度快）   </p></blockquote><p>或者</p><p>github</p><blockquote><p>git clone <a href="https://github.com/dianping/cat" target="_blank" rel="noopener">https://github.com/dianping/cat</a> </p></blockquote><p>2、下载服务器端包cat.war </p><blockquote><p><a href="http://unidal.org/nexus/service/local/repositories/releases/content/com/dianping/cat/cat-home/3.0.0/cat-home-3.0.0.war" target="_blank" rel="noopener">http://unidal.org/nexus/service/local/repositories/releases/content/com/dianping/cat/cat-home/3.0.0/cat-home-3.0.0.war</a> 记得重命名为cat.war</p></blockquote><blockquote><p>mv cat-home-3.0.0.war cat.war</p></blockquote><p>3、发布cat.war包前的准备工作</p><p>a、数据库初始化</p><p>创建cat库》找到源码中根目录下script/CatApplication.sql文件》在cat库中执行脚本</p><p>b、创建配置文件目录（<strong>注意目录必须有读写权限</strong>）<br>   /data/appdatas/cat ,/data/applogs/cat，然后权限</p><blockquote><p>chmod 777 /data/ -R</p></blockquote><p>c、 进入/data/appdatas/cat 目录,新建server.xml,datasources.xml配置文件</p><blockquote><p>vim server.xml</p></blockquote><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">config</span> <span class="attr">mode</span>=<span class="string">"client"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servers</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">server</span> <span class="attr">ip</span>=<span class="string">"你的内网ip"</span> <span class="attr">port</span>=<span class="string">"2280"</span> <span class="attr">http-port</span>=<span class="string">"8080"</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 集群时添加其他服务器  </span></span><br><span class="line"><span class="comment">        &lt;server ip="你的内网ip" port="2280" http-port="8080"/&gt; </span></span><br><span class="line"><span class="comment">        --&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servers</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">config</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><blockquote><p>vim datasources.xml<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">data-sources</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">data-source</span> <span class="attr">id</span>=<span class="string">"cat"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">maximum-pool-size</span>&gt;</span>3<span class="tag">&lt;/<span class="name">maximum-pool-size</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">connection-timeout</span>&gt;</span>1s<span class="tag">&lt;/<span class="name">connection-timeout</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">idle-timeout</span>&gt;</span>10m<span class="tag">&lt;/<span class="name">idle-timeout</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">statement-cache-size</span>&gt;</span>1000<span class="tag">&lt;/<span class="name">statement-cache-size</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">driver</span>&gt;</span>com.mysql.jdbc.Driver<span class="tag">&lt;/<span class="name">driver</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">url</span>&gt;</span>&lt;![CDATA[jdbc:mysql://127.0.0.1:3306/cat]]&gt;<span class="tag">&lt;/<span class="name">url</span>&gt;</span>  <span class="comment">&lt;!-- 请替换为真实数据库URL及Port  --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">user</span>&gt;</span>root<span class="tag">&lt;/<span class="name">user</span>&gt;</span>  <span class="comment">&lt;!-- 请替换为真实数据库用户名  --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">password</span>&gt;</span>root<span class="tag">&lt;/<span class="name">password</span>&gt;</span>  <span class="comment">&lt;!-- 请替换为真实数据库密码  --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">connectionProperties</span>&gt;</span>&lt;![CDATA[useUnicode=true&amp;characterEncoding=UTF-8&amp;autoReconnect=true&amp;socketTimeout=120000]]&gt;<span class="tag">&lt;/<span class="name">connectionProperties</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">data-source</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">data-sources</span>&gt;</span></span><br></pre></td></tr></table></figure></p></blockquote><p>d、发布cat.war包</p><p>修改tomcat server.xml配置编码<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Connector</span> <span class="attr">port</span>=<span class="string">"8080"</span> <span class="attr">protocol</span>=<span class="string">"HTTP/1.1"</span></span></span><br><span class="line"><span class="tag">           <span class="attr">URIEncoding</span>=<span class="string">"utf-8"</span>    <span class="attr">connectionTimeout</span>=<span class="string">"20000"</span></span></span><br><span class="line"><span class="tag">               <span class="attr">redirectPort</span>=<span class="string">"8443"</span> /&gt;</span>  <span class="comment">&lt;!-- 增加  URIEncoding="utf-8"  --&gt;</span>  </span><br></pre></td></tr></table></figure></p><p>将cat.war包拷贝到tomcat 的webapps目录中</p><p>启动tomcat</p><p><a href="http://ip:8080/cat/s/config?op=routerConfigUpdate" target="_blank" rel="noopener">http://ip:8080/cat/s/config?op=routerConfigUpdate</a> </p><p><strong>记得开放你的8080端口</strong><br>默认用户名admin admin</p><p>e、配置客户端路由<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">router-config</span> <span class="attr">backup-server</span>=<span class="string">"cat服务器端的ip"</span> <span class="attr">backup-server-port</span>=<span class="string">"2280"</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">default-server</span> <span class="attr">id</span>=<span class="string">"cat服务器端的ip"</span> <span class="attr">weight</span>=<span class="string">"1.0"</span> <span class="attr">port</span>=<span class="string">"2280"</span> <span class="attr">enable</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">network-policy</span> <span class="attr">id</span>=<span class="string">"default"</span> <span class="attr">title</span>=<span class="string">"default"</span> <span class="attr">block</span>=<span class="string">"false"</span> <span class="attr">server-group</span>=<span class="string">"default_group"</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">network-policy</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">server-group</span> <span class="attr">id</span>=<span class="string">"default_group"</span> <span class="attr">title</span>=<span class="string">"default-group"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">group-server</span> <span class="attr">id</span>=<span class="string">"cat服务器端的ip"</span>/&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">server-group</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">router-config</span>&gt;</span></span><br></pre></td></tr></table></figure><br>配置完成后需要重启tomcat<br>在application标签中如果能出现下图 则说明服务器端安装成功了<br><img src="http://pm8ml1daf.bkt.clouddn.com/blog/catsuccess.png" alt="image"></p><p>很多网上的事例都只到这步，其实真正使用cat才只得一点准备工作呢，下面我们来看看客户端集成</p><h4 id="三、客户端集成"><a href="#三、客户端集成" class="headerlink" title="三、客户端集成"></a>三、客户端集成</h4><p>本文主要介绍集成监控spirngboot项目、Service、mybatis。</p><p>1、本地jar包上传到仓库</p><p>使用源码中 lib/java/jar中的cat_client.jar包上传到仓库；你也可以通过源码打包，但是打包过程可能会出现依赖包下载不下来的情况，建议配置阿里云镜像。</p><blockquote><p>mvn deploy:deploy-file -DgroupId=com.dianping.cat -DartifactId=cat-client -Dversion=3.0.0 -Dpackaging=jar -Dfile=C:\Users\ssd\Desktop\cat-client-3.0.0.jar -Durl=http://<strong>{ip}}:{port}</strong>/content/repositories/thirdparty/ -DrepositoryId=thirdparty<br>本地操作时不需要-Durl参数,注意修改-Dfile参数为你自己的目录</p></blockquote><p>2、项目中引入客户端依赖包<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.dianping.cat<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cat-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>3、项目更目录下创建/data/appdatas/cat ,/data/applogs/cat,<strong>同样需要读写权限</strong></p><blockquote><p>chmod 777 /data/ -R</p></blockquote><p>如果你的项目和服务端发布在一起的话，这不需要本步。如果是不同的机器<br>那么请在/data/appdatas/cat中创建server.xml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">config</span> <span class="attr">mode</span>=<span class="string">"client"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servers</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">server</span> <span class="attr">ip</span>=<span class="string">"你的内网ip"</span> <span class="attr">port</span>=<span class="string">"2280"</span> <span class="attr">http-port</span>=<span class="string">"8080"</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 集群时添加其他服务器  </span></span><br><span class="line"><span class="comment">        &lt;server ip="你的内网ip" port="2280" http-port="8080"/&gt; </span></span><br><span class="line"><span class="comment">        --&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servers</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">config</span>&gt;</span></span><br></pre></td></tr></table></figure><p>4、将下面的类放到springboot能扫描到的目录下<br>新建CatFilterConfigure.java类<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.dianping.cat.servlet.CatFilter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.web.servlet.FilterRegistrationBean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by zhengwenzhu on 2017/1/17.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CatFilterConfigure</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> FilterRegistrationBean <span class="title">catFilter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        FilterRegistrationBean registration = <span class="keyword">new</span> FilterRegistrationBean();</span><br><span class="line">        CatFilter filter = <span class="keyword">new</span> CatFilter();</span><br><span class="line">        registration.setFilter(filter);</span><br><span class="line">        registration.addUrlPatterns(<span class="string">"/*"</span>);</span><br><span class="line">        registration.setName(<span class="string">"cat-filter"</span>);</span><br><span class="line">        registration.setOrder(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> registration;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>新建OAClientConfigProvider.java类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.tanqp.demo.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.dianping.cat.configuration.ClientConfigProvider;</span><br><span class="line"><span class="keyword">import</span> com.dianping.cat.configuration.client.entity.ClientConfig;</span><br><span class="line"><span class="keyword">import</span> com.dianping.cat.configuration.client.entity.Server;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>:xuecx</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@descript</span>:&lt;p&gt; &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span>:2019/2/21</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyClientConfigProvider</span> <span class="keyword">implements</span> <span class="title">ClientConfigProvider</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ClientConfig <span class="title">getClientConfig</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        List&lt;Server&gt; servers = <span class="keyword">new</span> ArrayList&lt;Server&gt;();</span><br><span class="line">        servers.add(<span class="keyword">new</span> Server(<span class="string">"你的服务器ip"</span>));</span><br><span class="line">        <span class="comment">//需要和app.name以及服务器上配置的一直</span></span><br><span class="line">        String domain = <span class="string">"test"</span>;</span><br><span class="line">        ClientConfig config = <span class="keyword">new</span> ClientConfig();</span><br><span class="line">        config.setServers(servers);</span><br><span class="line">        config.setDomain(domain);</span><br><span class="line">        <span class="keyword">return</span> config;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>5、在resources中新建META-INF/services目录</p><p>META-INF目录下新建app.properties 内容如下：</p><blockquote><p>app.name=test</p></blockquote><p>services目录中添加文件名为com.dianping.cat.configuration.ClientConfigProvider的文件 内容如下</p><blockquote><p>com.tanqp.demo.config.MyClientConfigProvider</p></blockquote><p>6、集成mybatis，在config配置目录下（springboot能扫描到即可）添加如下类<br>CatMybatisPlugin.java<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.tanqp.demo.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.dianping.cat.Cat;</span><br><span class="line"><span class="keyword">import</span> com.dianping.cat.message.Message;</span><br><span class="line"><span class="keyword">import</span> com.dianping.cat.message.Transaction;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.logging.Log;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.logging.LogFactory;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.executor.Executor;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.mapping.BoundSql;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.mapping.MappedStatement;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.mapping.ParameterMapping;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.mapping.SqlCommandType;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.plugin.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.reflection.MetaObject;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.session.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.session.ResultHandler;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.session.RowBounds;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.type.TypeHandlerRegistry;</span><br><span class="line"><span class="keyword">import</span> org.mybatis.spring.transaction.SpringManagedTransaction;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.ReflectionUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.sql.DataSource;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.text.DateFormat;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ConcurrentHashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.regex.Matcher;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * https://github.com/fanlychie/cat-client-mybatis</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Intercepts</span>(&#123;</span><br><span class="line">        <span class="meta">@Signature</span>(</span><br><span class="line">                method = <span class="string">"query"</span>,</span><br><span class="line">                type = Executor.class,</span><br><span class="line">                args = &#123;MappedStatement.class, Object.class, RowBounds.class, ResultHandler.class&#125;</span><br><span class="line">        ),</span><br><span class="line">        <span class="meta">@Signature</span>(</span><br><span class="line">                method = <span class="string">"update"</span>,</span><br><span class="line">                type = Executor.class,</span><br><span class="line">                args = &#123;MappedStatement.class, Object.class&#125;</span><br><span class="line">        )</span><br><span class="line">&#125;)</span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CatMybatisPlugin</span> <span class="keyword">implements</span> <span class="title">Interceptor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Log logger = LogFactory.getLog(CatMybatisPlugin.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//缓存，提高性能</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;String, String&gt; sqlURLCache = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;(<span class="number">256</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String EMPTY_CONNECTION = <span class="string">"jdbc:mysql://unknown:3306/%s?useUnicode=true"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Executor target;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// druid 数据源的类名称</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String DruidDataSourceClassName = <span class="string">"com.alibaba.druid.pool.DruidDataSource"</span>;</span><br><span class="line">    <span class="comment">// dbcp 数据源的类名称</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String DBCPBasicDataSourceClassName = <span class="string">"org.apache.commons.dbcp.BasicDataSource"</span>;</span><br><span class="line">    <span class="comment">// dbcp2 数据源的类名称</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String DBCP2BasicDataSourceClassName = <span class="string">"org.apache.commons.dbcp2.BasicDataSource"</span>;</span><br><span class="line">    <span class="comment">// c3p0 数据源的类名称</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String C3P0ComboPooledDataSourceClassName = <span class="string">"com.mchange.v2.c3p0.ComboPooledDataSource"</span>;</span><br><span class="line">    <span class="comment">// HikariCP 数据源的类名称</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String HikariCPDataSourceClassName = <span class="string">"com.zaxxer.hikari.HikariDataSource"</span>;</span><br><span class="line">    <span class="comment">// BoneCP 数据源的类名称</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String BoneCPDataSourceClassName = <span class="string">"com.jolbox.bonecp.BoneCPDataSource"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">intercept</span><span class="params">(Invocation invocation)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        MappedStatement mappedStatement = (MappedStatement) invocation.getArgs()[<span class="number">0</span>];</span><br><span class="line">        <span class="comment">//得到类名，方法</span></span><br><span class="line">        String[] strArr = mappedStatement.getId().split(<span class="string">"\\."</span>);</span><br><span class="line">        String methodName = strArr[strArr.length - <span class="number">2</span>] + <span class="string">"."</span> + strArr[strArr.length - <span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">        Transaction t = Cat.newTransaction(<span class="string">"SQL"</span>, methodName);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//得到sql语句</span></span><br><span class="line">        Object parameter = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (invocation.getArgs().length &gt; <span class="number">1</span>) &#123;</span><br><span class="line">            parameter = invocation.getArgs()[<span class="number">1</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        BoundSql boundSql = mappedStatement.getBoundSql(parameter);</span><br><span class="line">        Configuration configuration = mappedStatement.getConfiguration();</span><br><span class="line">        String sql = showSql(configuration, boundSql);</span><br><span class="line"></span><br><span class="line">        String s = <span class="keyword">this</span>.getSQLDatabase();</span><br><span class="line">        Cat.logEvent(<span class="string">"SQL.Database"</span>, s);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取SQL类型</span></span><br><span class="line">        SqlCommandType sqlCommandType = mappedStatement.getSqlCommandType();</span><br><span class="line">        Cat.logEvent(<span class="string">"SQL.Method"</span>, sqlCommandType.name().toLowerCase(), Message.SUCCESS, sql);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        Object returnObj = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            returnObj = invocation.proceed();</span><br><span class="line">            t.setStatus(Transaction.SUCCESS);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            Cat.logError(e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            t.complete();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> returnObj;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> javax.sql.<span class="function">DataSource <span class="title">getDataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        org.apache.ibatis.transaction.Transaction transaction = <span class="keyword">this</span>.target.getTransaction();</span><br><span class="line">        <span class="keyword">if</span> (transaction == <span class="keyword">null</span>) &#123;</span><br><span class="line">            logger.error(String.format(<span class="string">"Could not find transaction on target [%s]"</span>, <span class="keyword">this</span>.target));</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (transaction <span class="keyword">instanceof</span> SpringManagedTransaction) &#123;</span><br><span class="line">            String fieldName = <span class="string">"dataSource"</span>;</span><br><span class="line">            Field field = ReflectionUtils.findField(transaction.getClass(), fieldName, javax.sql.DataSource.class);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (field == <span class="keyword">null</span>) &#123;</span><br><span class="line">                logger.error(String.format(<span class="string">"Could not find field [%s] of type [%s] on target [%s]"</span>,</span><br><span class="line">                        fieldName, javax.sql.DataSource.class, <span class="keyword">this</span>.target));</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ReflectionUtils.makeAccessible(field);</span><br><span class="line">            javax.sql.DataSource dataSource = (javax.sql.DataSource) ReflectionUtils.getField(field, transaction);</span><br><span class="line">            <span class="keyword">return</span> dataSource;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        logger.error(String.format(<span class="string">"---the transaction is not SpringManagedTransaction:%s"</span>, transaction.getClass().toString()));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 重写 getSqlURL 方法</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> fanlychie (https://github.com/fanlychie)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">getSqlURL</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 客户端使用的数据源</span></span><br><span class="line">        javax.sql.DataSource dataSource = <span class="keyword">this</span>.getDataSource();</span><br><span class="line">        <span class="keyword">if</span> (dataSource != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 处理常见的数据源</span></span><br><span class="line">            <span class="keyword">switch</span> (dataSource.getClass().getName()) &#123;</span><br><span class="line">                <span class="comment">// druid</span></span><br><span class="line">                <span class="keyword">case</span> DruidDataSourceClassName:</span><br><span class="line">                    <span class="keyword">return</span> getDataSourceSqlURL(dataSource, DruidDataSourceClassName, <span class="string">"getUrl"</span>);</span><br><span class="line">                <span class="comment">// dbcp</span></span><br><span class="line">                <span class="keyword">case</span> DBCPBasicDataSourceClassName:</span><br><span class="line">                    <span class="keyword">return</span> getDataSourceSqlURL(dataSource, DBCPBasicDataSourceClassName, <span class="string">"getUrl"</span>);</span><br><span class="line">                <span class="comment">// dbcp2</span></span><br><span class="line">                <span class="keyword">case</span> DBCP2BasicDataSourceClassName:</span><br><span class="line">                    <span class="keyword">return</span> getDataSourceSqlURL(dataSource, DBCP2BasicDataSourceClassName, <span class="string">"getUrl"</span>);</span><br><span class="line">                <span class="comment">// c3p0</span></span><br><span class="line">                <span class="keyword">case</span> C3P0ComboPooledDataSourceClassName:</span><br><span class="line">                    <span class="keyword">return</span> getDataSourceSqlURL(dataSource, C3P0ComboPooledDataSourceClassName, <span class="string">"getJdbcUrl"</span>);</span><br><span class="line">                <span class="comment">// HikariCP</span></span><br><span class="line">                <span class="keyword">case</span> HikariCPDataSourceClassName:</span><br><span class="line">                    <span class="keyword">return</span> getDataSourceSqlURL(dataSource, HikariCPDataSourceClassName, <span class="string">"getJdbcUrl"</span>);</span><br><span class="line">                <span class="comment">// BoneCP</span></span><br><span class="line">                <span class="keyword">case</span> BoneCPDataSourceClassName:</span><br><span class="line">                    <span class="keyword">return</span> getDataSourceSqlURL(dataSource, BoneCPDataSourceClassName, <span class="string">"getJdbcUrl"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取数据源的SQL地址</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> dataSource                 数据源</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> runtimeDataSourceClassName 运行时真实的数据源的类名称</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> sqlURLMethodName           获取SQL地址的方法名称</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">getDataSourceSqlURL</span><span class="params">(DataSource dataSource, String runtimeDataSourceClassName, String sqlURLMethodName)</span> </span>&#123;</span><br><span class="line">        Class&lt;?&gt; dataSourceClass = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            dataSourceClass = Class.forName(runtimeDataSourceClassName);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">        Method sqlURLMethod = ReflectionUtils.findMethod(dataSourceClass, sqlURLMethodName);</span><br><span class="line">        <span class="keyword">return</span> (String) ReflectionUtils.invokeMethod(sqlURLMethod, dataSource);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">getSQLDatabase</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="comment">//        String dbName = RouteDataSourceContext.getRouteKey();</span></span><br><span class="line">        String dbName = <span class="keyword">null</span>; <span class="comment">//根据设置的多数据源修改此处,获取dbname</span></span><br><span class="line">        <span class="keyword">if</span> (dbName == <span class="keyword">null</span>) &#123;</span><br><span class="line">            dbName = <span class="string">"DEFAULT"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        String url = CatMybatisPlugin.sqlURLCache.get(dbName);</span><br><span class="line">        <span class="keyword">if</span> (url != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> url;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        url = <span class="keyword">this</span>.getSqlURL();<span class="comment">//目前监控只支持mysql ,其余数据库需要各自修改监控服务端</span></span><br><span class="line">        <span class="keyword">if</span> (url == <span class="keyword">null</span>) &#123;</span><br><span class="line">            url = String.format(EMPTY_CONNECTION, dbName);</span><br><span class="line">        &#125;</span><br><span class="line">        CatMybatisPlugin.sqlURLCache.put(dbName, url);</span><br><span class="line">        <span class="keyword">return</span> url;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 解析sql语句</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> configuration</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> boundSql</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">showSql</span><span class="params">(Configuration configuration, BoundSql boundSql)</span> </span>&#123;</span><br><span class="line">        Object parameterObject = boundSql.getParameterObject();</span><br><span class="line">        List&lt;ParameterMapping&gt; parameterMappings = boundSql.getParameterMappings();</span><br><span class="line">        String sql = boundSql.getSql().replaceAll(<span class="string">"[\\s]+"</span>, <span class="string">" "</span>);</span><br><span class="line">        <span class="keyword">if</span> (parameterMappings.size() &gt; <span class="number">0</span> &amp;&amp; parameterObject != <span class="keyword">null</span>) &#123;</span><br><span class="line">            TypeHandlerRegistry typeHandlerRegistry = configuration.getTypeHandlerRegistry();</span><br><span class="line">            <span class="keyword">if</span> (typeHandlerRegistry.hasTypeHandler(parameterObject.getClass())) &#123;</span><br><span class="line">                sql = sql.replaceFirst(<span class="string">"\\?"</span>, Matcher.quoteReplacement(getParameterValue(parameterObject)));</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                MetaObject metaObject = configuration.newMetaObject(parameterObject);</span><br><span class="line">                <span class="keyword">for</span> (ParameterMapping parameterMapping : parameterMappings) &#123;</span><br><span class="line">                    String propertyName = parameterMapping.getProperty();</span><br><span class="line">                    <span class="keyword">if</span> (metaObject.hasGetter(propertyName)) &#123;</span><br><span class="line">                        Object obj = metaObject.getValue(propertyName);</span><br><span class="line">                        sql = sql.replaceFirst(<span class="string">"\\?"</span>, Matcher.quoteReplacement(getParameterValue(obj)));</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (boundSql.hasAdditionalParameter(propertyName)) &#123;</span><br><span class="line">                        Object obj = boundSql.getAdditionalParameter(propertyName);</span><br><span class="line">                        sql = sql.replaceFirst(<span class="string">"\\?"</span>, Matcher.quoteReplacement(getParameterValue(obj)));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sql;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 参数解析</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> obj</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">getParameterValue</span><span class="params">(Object obj)</span> </span>&#123;</span><br><span class="line">        String value = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (obj <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">            value = <span class="string">"'"</span> + obj.toString() + <span class="string">"'"</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (obj <span class="keyword">instanceof</span> Date) &#123;</span><br><span class="line">            DateFormat formatter = DateFormat.getDateTimeInstance(DateFormat.DEFAULT, DateFormat.DEFAULT, Locale.CHINA);</span><br><span class="line">            value = <span class="string">"'"</span> + formatter.format(<span class="keyword">new</span> Date()) + <span class="string">"'"</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (obj != <span class="keyword">null</span>) &#123;</span><br><span class="line">                value = obj.toString();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                value = <span class="string">""</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">plugin</span><span class="params">(Object target)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (target <span class="keyword">instanceof</span> Executor) &#123;</span><br><span class="line">            <span class="keyword">this</span>.target = (Executor) target;</span><br><span class="line">            <span class="keyword">return</span> Plugin.wrap(target, <span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> target;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setProperties</span><span class="params">(Properties properties)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>7、登录cat服务器端，配置项目 如下图</p><p><img src="http://pm8ml1daf.bkt.clouddn.com/blog/catcz.png" alt="image"></p><p>8 全局配置》消息采样配置</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">sample-config</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">domain</span> <span class="attr">id</span>=<span class="string">"cat"</span> <span class="attr">sample</span>=<span class="string">"1.0"</span>/&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">domain</span> <span class="attr">id</span>=<span class="string">"test"</span> <span class="attr">sample</span>=<span class="string">"1.0"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">sample-config</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>发布你的项目，并发送几个请求，出现如下图则说明成功了,图中显示的service需要做第10步的操作；<br><img src="http://pm8ml1daf.bkt.clouddn.com/blog/cattest.png" alt="image"></p><p>10、编写aop监控service </p><p>ServiceAspect.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.tanqp.demo.aop;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSONObject;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.serializer.SerializerFeature;</span><br><span class="line"><span class="keyword">import</span> com.dianping.cat.Cat;</span><br><span class="line"><span class="keyword">import</span> com.dianping.cat.message.Event;</span><br><span class="line"><span class="keyword">import</span> com.dianping.cat.message.Transaction;</span><br><span class="line"><span class="keyword">import</span> com.tanqp.demo.entity.AccessLog;</span><br><span class="line"><span class="keyword">import</span> com.tanqp.demo.enums.LogType;</span><br><span class="line"><span class="keyword">import</span> com.tanqp.demo.exception.DemoException;</span><br><span class="line"><span class="keyword">import</span> com.tanqp.demo.service.AccessLogService;</span><br><span class="line"><span class="keyword">import</span> com.tanqp.demo.utils.NetworkUtil;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.JoinPoint;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.*;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.context.request.RequestContextHolder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.context.request.ServletRequestAttributes;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>:xuecx</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@CreateDate</span>: 2018/3/17.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@QQ</span>:1276162287</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Discription</span>:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServiceAspect</span> </span>&#123;</span><br><span class="line">    Logger logger = LoggerFactory.getLogger(ServiceAspect.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Pointcut</span>(<span class="string">"execution(public * com.tanqp.demo.service.*.*(..))"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">log</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before</span>(<span class="string">"log()"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">boBefore</span><span class="params">(JoinPoint joinPoint)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        Object[] args1 = joinPoint.getArgs();</span><br><span class="line">        Transaction t = Cat.newTransaction(<span class="string">"SERVICE"</span>, joinPoint.getSignature().getName());</span><br><span class="line">        Cat.logEvent(<span class="string">"URL.Server"</span>, joinPoint.getSignature().getDeclaringTypeName(), Event.SUCCESS,  JSONObject.toJSONString(args1));</span><br><span class="line">        Cat.logMetricForCount(<span class="string">"metric.key"</span>);</span><br><span class="line">        Cat.logMetricForDuration(<span class="string">"metric.key"</span>, <span class="number">5</span>);</span><br><span class="line">        t.setStatus(Transaction.SUCCESS);</span><br><span class="line">        t.complete();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@After</span>(<span class="string">"log()"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doAffter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        logger.info(<span class="string">"处理中"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@AfterReturning</span>(pointcut = <span class="string">"log()"</span>, returning = <span class="string">"object"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doAffterReturning</span><span class="params">(Object object)</span> </span>&#123;</span><br><span class="line">        logger.info(<span class="string">"return=&#123;&#125;"</span>, object.toString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@AfterThrowing</span>(pointcut = <span class="string">"log()"</span>, throwing = <span class="string">"e"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doAfterThrowing</span><span class="params">(Throwable e)</span> </span>&#123;</span><br><span class="line">        Transaction t = Cat.newTransaction(<span class="string">"SERVICE"</span>, <span class="string">"Name"</span>);</span><br><span class="line">        t.setStatus(e);</span><br><span class="line">        Cat.logError(e);</span><br><span class="line">        t.complete();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="四、总结"><a href="#四、总结" class="headerlink" title="四、总结"></a>四、总结</h4><p>1、如果项目是从头开始，需要定制监控某些接口，那么可以使用cat，cat更多的是使用它的埋点监控，对于已经上线的项目建议使用pinpoint（0代码侵入监控）；</p><p>2、另外基于mybatis拦截器的监控 没有select的，只有update和insert，当然可以自己写关键的sql发送到服务器端；</p><p>3、对代码有影响，需要做降级处理；</p><p><a href="http://www.chansung.cn/article/8" target="_blank" rel="noopener">pinpoint安装学习教程</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h4 id=&quot;一、环境清单&quot;&gt;&lt;a href=&quot;#一、环境清单&quot; class=&quot;headerlink&quot; title=&quot;一、环境清单&quot;&gt;&lt;/a&gt;一、环境清单&lt;/h4&gt;&lt;p&gt;CentOS 7、mysql5.6、安装jdk8、安装maven3以上、安装tomcat8、安装git&lt;/p
      
    
    </summary>
    
    
      <category term="cat" scheme="https://blog.520xnc.cn/tags/cat/"/>
    
  </entry>
  
  <entry>
    <title>并发量吞吐量响应时间的关系</title>
    <link href="https://blog.520xnc.cn/2019/02/14/20190214084943/"/>
    <id>https://blog.520xnc.cn/2019/02/14/20190214084943/</id>
    <published>2019-02-14T00:49:43.000Z</published>
    <updated>2019-02-14T01:03:16.880Z</updated>
    
    <content type="html"><![CDATA[<p>  在日常工作中经常会听到QPS/TPS这些名词，也会经常被别人问起说你的系统吞吐量有多大。这个问题从业务上来讲，<br>可以理解为应用系统每秒钟最大能接受的用户访问量。或者每秒钟最大能处理的请求数；</p><p>QPS: 每秒钟处理完请求的次数；注意这里是处理完。具体是指发出请求到服务器处理完成功返回结果。可以理解在server中有个counter，每处理一个请求加1，1秒后counter=QPS。<br>==可理解为单个接口服务==</p><p>TPS：每秒钟处理完的事务次数，一般TPS是对整个系统来讲的。一个应用系统1s能完成多少事务处理，一个事务在分布式处理中，可能会对应多个请求，对于衡量单个接口服务的处理能力，用QPS比较多。<br>==可理解为一个功能按钮==</p><p>并发量：系统能同时处理的请求数</p><p>RT：响应时间，处理一次请求所需要的平均处理时间</p><p>计算关系：</p><p>QPS = 并发量 / 平均响应时间</p><p>并发量 = QPS * 平均响应时间</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;  在日常工作中经常会听到QPS/TPS这些名词，也会经常被别人问起说你的系统吞吐量有多大。这个问题从业务上来讲，&lt;br&gt;可以理解为应用系统每秒钟最大能接受的用户访问量。或者每秒钟最大能处理的请求数；&lt;/p&gt;
&lt;p&gt;QPS: 每秒钟处理完请求的次数；注意这里是处理完。具体是
      
    
    </summary>
    
    
      <category term="其他" scheme="https://blog.520xnc.cn/tags/%E5%85%B6%E4%BB%96/"/>
    
  </entry>
  
  <entry>
    <title>git配置ssh免密登录</title>
    <link href="https://blog.520xnc.cn/2019/01/31/one/"/>
    <id>https://blog.520xnc.cn/2019/01/31/one/</id>
    <published>2019-01-31T08:04:05.000Z</published>
    <updated>2019-02-18T08:57:56.164Z</updated>
    
    <content type="html"><![CDATA[<h1 id="git-配置免密登录"><a href="#git-配置免密登录" class="headerlink" title="git 配置免密登录"></a>git 配置免密登录</h1><p>1、生成sshkey</p><blockquote><p>ssh-keygen -t rsa -C “<a href="mailto:xxx@xxx.com" target="_blank" rel="noopener">xxx@xxx.com</a>“</p></blockquote><p>注意：如果没有这个命令,找到git中的安装目录  \Git\usr\bin(C:\Program Files\Git\usr\bin)设置环境变量；或者直接在任何目录下右键 选择Git Bash here。</p><h6 id="其中需要输入的地方什么东不填，如果你填了密码，后面会多很多步骤"><a href="#其中需要输入的地方什么东不填，如果你填了密码，后面会多很多步骤" class="headerlink" title="其中需要输入的地方什么东不填，如果你填了密码，后面会多很多步骤"></a>其中需要输入的地方什么东不填，如果你填了密码，后面会多很多步骤</h6><p><img src="https://blog.520xnc.cn/img/ssh.png" alt="Image text"></p><p>2、点击github中我的头像边上的小三角&gt;setting&gt;ssh and GPG keys&gt;new ssh key<br>title可以随便填，key就是我们第一步生成的，key在~/.ssh/id_rsa.pub文件中，复制里面的内容放到key中</p><p>注意：不要加任意的字符，如空格或者回车</p><p>3、验证</p><blockquote><p>git clone <a href="mailto:git@github.com" target="_blank" rel="noopener">git@github.com</a>:xuecx/xuecx.github.io.git</p></blockquote><p>如果能正常克隆代码 就说明成功了。</p><p>文章原始地址：<a href="https://blog.520xnc.cn/2019/01/31/git%E9%85%8D%E7%BD%AEssh%E5%85%8D%E5%AF%86%E7%99%BB%E5%BD%95/">https://blog.520xnc.cn/2019/01/31/git%E9%85%8D%E7%BD%AEssh%E5%85%8D%E5%AF%86%E7%99%BB%E5%BD%95/</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;git-配置免密登录&quot;&gt;&lt;a href=&quot;#git-配置免密登录&quot; class=&quot;headerlink&quot; title=&quot;git 配置免密登录&quot;&gt;&lt;/a&gt;git 配置免密登录&lt;/h1&gt;&lt;p&gt;1、生成sshkey&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;ssh-key
      
    
    </summary>
    
    
      <category term="git" scheme="https://blog.520xnc.cn/tags/git/"/>
    
      <category term="ssh" scheme="https://blog.520xnc.cn/tags/ssh/"/>
    
  </entry>
  
  <entry>
    <title>java线上堆栈信息查看</title>
    <link href="https://blog.520xnc.cn/2019/01/31/two/"/>
    <id>https://blog.520xnc.cn/2019/01/31/two/</id>
    <published>2019-01-31T02:40:48.000Z</published>
    <updated>2019-02-18T08:58:11.129Z</updated>
    
    <content type="html"><![CDATA[<h1 id="jstack查看java堆栈信息"><a href="#jstack查看java堆栈信息" class="headerlink" title="jstack查看java堆栈信息"></a>jstack查看java堆栈信息</h1><p>1、top 查看占用资源多的进程：pid</p><p>2、top -H -p pid  查看对应pid的线程，并找到占用资源多的线程</p><p>3、printf “%x\n” pid 转化为十六进制</p><p>4、在pid.stack中查找对应十六进制的信息</p><p>jstack -l pid &gt; pid.stack，将堆栈信息dump到pid.stack文件中</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;jstack查看java堆栈信息&quot;&gt;&lt;a href=&quot;#jstack查看java堆栈信息&quot; class=&quot;headerlink&quot; title=&quot;jstack查看java堆栈信息&quot;&gt;&lt;/a&gt;jstack查看java堆栈信息&lt;/h1&gt;&lt;p&gt;1、top 查看占用资源多的
      
    
    </summary>
    
    
      <category term="Linux" scheme="https://blog.520xnc.cn/tags/Linux/"/>
    
      <category term="堆栈" scheme="https://blog.520xnc.cn/tags/%E5%A0%86%E6%A0%88/"/>
    
      <category term="java" scheme="https://blog.520xnc.cn/tags/java/"/>
    
      <category term="mysql" scheme="https://blog.520xnc.cn/tags/mysql/"/>
    
      <category term="redis" scheme="https://blog.520xnc.cn/tags/redis/"/>
    
      <category term="Mongodb" scheme="https://blog.520xnc.cn/tags/Mongodb/"/>
    
      <category term="oracle" scheme="https://blog.520xnc.cn/tags/oracle/"/>
    
      <category term="设计模式" scheme="https://blog.520xnc.cn/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"/>
    
      <category term="其他" scheme="https://blog.520xnc.cn/tags/%E5%85%B6%E4%BB%96/"/>
    
  </entry>
  
  <entry>
    <title>java线程池要点</title>
    <link href="https://blog.520xnc.cn/2018/06/19/20180619105824/"/>
    <id>https://blog.520xnc.cn/2018/06/19/20180619105824/</id>
    <published>2018-06-19T02:58:24.000Z</published>
    <updated>2019-02-19T03:11:08.374Z</updated>
    
    <content type="html"><![CDATA[<h4 id="一、线程池框架jdk引入版本"><a href="#一、线程池框架jdk引入版本" class="headerlink" title="一、线程池框架jdk引入版本"></a>一、线程池框架jdk引入版本</h4><p>jdk1.5引入Executor线程池框架，通过它把任务的提交和执行进行解耦，只需要定义好任务，然后提交给线程池，而不用关心该任务是如何执行、被哪个线程执行，以及什么时候执行。</p><h4 id="二、通过Executors类初始化"><a href="#二、通过Executors类初始化" class="headerlink" title="二、通过Executors类初始化"></a>二、通过Executors类初始化</h4><p><strong>newFixedThreadPool()</strong></p><p>说明：初始化一个指定线程数的线程池，其中corePoolSize == maxiPoolSize，使用LinkedBlockingQuene作为阻塞队列</p><p>特点：即使当线程池没有可执行任务时，也不会释放线程。</p><p><strong>newCachedThreadPool()</strong></p><p>说明：初始化一个可以缓存线程的线程池，默认缓存60s，线程池的线程数可达到Integer.MAX_VALUE，即2147483647，内部使用SynchronousQueue作为阻塞队列；</p><p>特点：在没有任务执行时，当线程的空闲时间超过keepAliveTime，会自动释放线程资源；当提交新任务时，如果没有空闲线程，则创建新线程执行任务，会导致一定的系统开销；因此，使用时要注意控制并发的任务数，防止因创建大量的线程导致而降低性能。</p><p><strong>newSingleThreadExecutor()</strong></p><p>说明：初始化只有一个线程的线程池，内部使用LinkedBlockingQueue作为阻塞队列。</p><p>特点：如果该线程异常结束，会重新创建一个新的线程继续执行任务，唯一的线程可以保证所提交任务的顺序执行；</p><p><strong>newScheduledThreadPool()</strong></p><p>特点：初始化的线程池可以在指定的时间内周期性的执行所提交的任务，在实际的业务场景中可以使用该线程池定期的同步数据。</p><pre><code>总结</code></pre><p>除了newScheduledThreadPool的内部实现特殊一点之外，其它线程池内部都是基于ThreadPoolExecutor类（Executor的子类）实现的。</p><h4 id="三、ThreadPoolExecutor内部具体实现"><a href="#三、ThreadPoolExecutor内部具体实现" class="headerlink" title="三、ThreadPoolExecutor内部具体实现"></a>三、ThreadPoolExecutor内部具体实现</h4><p><strong>ThreadPoolExecutor类构造器语法形式</strong></p><p>ThreadPoolExecutor（corePoolSize,maxPoolSize,keepAliveTime,timeUnit,<br>workQueue,threadFactory,handle);   </p><p><strong>方法参数：</strong></p><p>corePoolSize：核心线程数</p><p>maxPoolSize：最大线程数</p><p>keepAliveTime：线程存活时间（在corePore&lt;*&lt;maxPoolSize情况下有用<br>    ）</p><p>timeUnit：存活时间的时间单位</p><p>workQueue：阻塞队列（用来保存等待被执行的任务）workQueue参数的取值,JDK提供了4种阻塞队列类型供选择</p><pre><code>ArrayBlockingQueue：基于数组结构的有界阻塞队列，按FIFO排序任务；LinkedBlockingQuene：基于链表结构的阻塞队列，按FIFO排序任务，吞吐量通常要高于ArrayBlockingQueue  SynchronousQuene：一个不存储元素的阻塞队列，每个插入操作必须等到另一个线程调用移除操作，否则插入操作一直处于阻塞状态，吞吐量通常要高于ArrayBlockingQuene；PriorityBlockingQuene：具有优先级的无界阻塞队列；</code></pre><p>threadFactory：线程工厂，主要用来创建线程；</p><p>handler：表示当拒绝处理任务时的策略,当线程池的饱和策略，当阻塞队列满了，且没有空闲的工作线程，如果继续提交任务，必须采取一种策略处理该任务，线程池提供了4种策略</p><pre><code>ThreadPoolExecutor.AbortPolicy:丢弃任务并抛出RejectedExecutionException异常;ThreadPoolExecutor.DiscardPolicy：也是丢弃任务，但是不抛出异常;ThreadPoolExecutor.DiscardOldestPolicy：丢弃队列最前面的任务，然后重新尝试执行任务（重复此过程）ThreadPoolExecutor.CallerRunsPolicy：由调用线程处理该任务当然也可以根据应用场景实现RejectedExecutionHandler接口，自定义饱和策略，如记录日志或持久化存储不能处理的任务。</code></pre><hr><h4 id="四、线程池的状态（5种）"><a href="#四、线程池的状态（5种）" class="headerlink" title="四、线程池的状态（5种）"></a>四、线程池的状态（5种）</h4><p>其中AtomicInteger变量ctl的功能非常强大：利用低29位表示线程池中线程数，通过高3位表示线程池的运行状态</p><p>1、RUNNING：-1 &lt;&lt; COUNT_BITS，即高3位为111，该状态的线程池会接收新任务，并处理阻塞队列中的任务；</p><p>2、SHUTDOWN： 0 &lt;&lt; COUNT_BITS，即高3位为000，该状态的线程池不会接收新任务，但会处理阻塞队列中的任务；</p><p>3、STOP ： 1 &lt;&lt; COUNT_BITS，即高3位为001，该状态的线程不会接收新任务，也不会处理阻塞队列中的任务，而且会中断正在运行的任务；<br>4、TIDYING ： 2 &lt;&lt; COUNT_BITS，即高3位为010，该状态表示线程池对线程进行整理优化；</p><p>5、TERMINATED： 3 &lt;&lt; COUNT_BITS，即高3位为011，该状态表示线程池停止工作；</p><pre><code>线程状态：1. 新建状态(New)：线程对象被创建后，就进入了新建状态。例如，Thread thread = new Thread()；2. 就绪状态(Runnable)：也被称为“可执行状态”。线程对象被创建后，其它线程调用了该对象的start()方法，从而来启动该线程。例如，thread.start()。处于就绪状态的线程，随时可能被CPU调度执行。3. 运行状态(Running) : 线程获取CPU权限进行执行。需要注意的是，线程只能从就绪状态进入到运行状态。4. 阻塞状态(Blocked)  : 阻塞状态是线程因为某种原因放弃CPU使用权，暂时停止运行。直到线程进入就绪状态，才有机会转到运行状态。阻塞的情况分三种：  (01) 等待阻塞 -- 通过调用线程的wait()方法，让线程等待某工作的完成。  (02) 同步阻塞 -- 线程在获取synchronized同步锁失败(因为锁被其它线程所占用)，它会进入同步阻塞状态。  (03) 其他阻塞 -- 通过调用线程的sleep()或join()或发出了I/O请求时，线程会进入到阻塞状态。当sleep()状态超时、join()等待线程终止或者超时、或者I/O处理完毕时，线程重新转入就绪状态。5. 死亡状态(Dead)    : 线程执行完了或者因异常退出了run()方法，该线程结束生命周期。</code></pre><hr><h4 id="五、向线程池提交任务（2种）"><a href="#五、向线程池提交任务（2种）" class="headerlink" title="五、向线程池提交任务（2种）"></a>五、向线程池提交任务（2种）</h4><pre><code>Executor.execute(Runnable command);ExecutorService.submit(Callable&lt;T&gt; task);</code></pre><p><strong>execute()内部实现</strong></p><p>1.首次通过workCountof()获知当前线程池中的线程数，如果小于corePoolSize,就通过addWorker()创建线程并执行该任务；否则，将该任务放入阻塞队列；</p><p>2.如果能成功将任务放入阻塞队列中,如果当前线程池是非RUNNING状态，则将该任务从阻塞队列中移除，然后执行reject()处理该任务；如果当前线程池处于RUNNING状态，则需要再次检查线程池（因为可能在上次检查后，有线程资源被释放），是否有空闲的线程；如果有则执行该任务；</p><p>3.如果不能将任务放入阻塞队列中,说明阻塞队列已满；那么将通过addWoker()尝试创建一个新的线程去执行这个任务；如果addWoker()执行失败，说明线程池中线程数达到maxPoolSize,则执行reject()处理任务；</p><p><strong> sumbit()内部实现</strong></p><p>会将提交的Callable任务会被封装成了一个FutureTask对象,FutureTask类实现了Runnable接口，这样就可以通过Executor.execute()提交FutureTask到线程池中等待被执行，最终执行的是FutureTask的run方法； </p><p><strong>比较：</strong></p><p>两个方法都可以向线程池提交任务，execute()方法的返回类型是void，它定义在Executor接口中, 而submit()方法可以返回持有计算结果的Future对象，它定义在ExecutorService接口中，它扩展了Executor接口，其它线程池类像ThreadPoolExecutor和ScheduledThreadPoolExecutor都有这些方法。 </p><hr><h4 id="六、线程池的关闭（2种）"><a href="#六、线程池的关闭（2种）" class="headerlink" title="六、线程池的关闭（2种）"></a>六、线程池的关闭（2种）</h4><pre><code>ThreadPoolExecutor提供了两个方法shutdown()shutdownNow()</code></pre><p>　　</p><p>1、shutdown()：不会立即终止线程池，而是要等所有任务缓存队列中的任务都执行完后才终止，但再也不会接受新的任务；</p><p>2、shutdownNow()：立即终止线程池，并尝试打断正在执行的任务，并且清空任务缓存队列，返回尚未执行的任务</p><hr><h4 id="七、线程池容量的动态调整"><a href="#七、线程池容量的动态调整" class="headerlink" title="七、线程池容量的动态调整"></a>七、线程池容量的动态调整</h4><pre><code>ThreadPoolExecutor提供了动态调整线程池容量大小的方法：setCorePoolSize()setMaximumPoolSize()</code></pre><h4 id="八、总结："><a href="#八、总结：" class="headerlink" title="八、总结："></a>八、总结：</h4><p>1、线程池中的核心线程数，当提交一个任务时，线程池创建一个新线程执行任务，直到当前线程数等于corePoolSize；如果当前线程数为corePoolSize，继续提交的任务被保存到阻塞队列中，等待被执行；如果阻塞队列满了，那就创建新的线程执行当前任务；直到线程池中的线程数达到maxPoolSize,这时再有任务来，只能执行reject()处理该任务；</p><p>2、如果执行了线程池的prestartAllCoreThreads()方法，线程池会提前创建并启动所有核心线程。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h4 id=&quot;一、线程池框架jdk引入版本&quot;&gt;&lt;a href=&quot;#一、线程池框架jdk引入版本&quot; class=&quot;headerlink&quot; title=&quot;一、线程池框架jdk引入版本&quot;&gt;&lt;/a&gt;一、线程池框架jdk引入版本&lt;/h4&gt;&lt;p&gt;jdk1.5引入Executor线程池框架，
      
    
    </summary>
    
    
      <category term="线程池" scheme="https://blog.520xnc.cn/tags/%E7%BA%BF%E7%A8%8B%E6%B1%A0/"/>
    
  </entry>
  
  <entry>
    <title>redis实现分布式锁解析</title>
    <link href="https://blog.520xnc.cn/2018/04/10/20180410152236/"/>
    <id>https://blog.520xnc.cn/2018/04/10/20180410152236/</id>
    <published>2018-04-10T07:22:36.000Z</published>
    <updated>2019-02-19T08:39:21.347Z</updated>
    
    <content type="html"><![CDATA[<p>分布式锁其实可以理解为：控制分布式系统有序的去对共享资源进行操作，通过互斥来保持一致性。 </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.redis.tool;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.dao.DataAccessException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.connection.RedisConnection;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisCallback;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.Jedis;</span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.JedisCluster;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Collections;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>:xuecx</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@descript</span>:&lt;p&gt;利用redis实现分布式锁&lt;/p&gt;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span>:2018/10/12</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisLock1</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 加锁</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> redisTemplate redis连接</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> lockKey       锁名称</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> retry         从试次数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> requestId     请求id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> expire        过期时间 单位s</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">lock</span><span class="params">(RedisTemplate redisTemplate, String lockKey, Integer retry, String requestId, <span class="keyword">int</span> expire)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; retry; i++) &#123;</span><br><span class="line">            <span class="comment">//如果键不存在则新增,存在则不改变已经有的值</span></span><br><span class="line">            Boolean hasLock = redisTemplate.opsForValue().setIfAbsent(lockKey, requestId);</span><br><span class="line">            <span class="keyword">if</span> (hasLock) &#123;</span><br><span class="line">                <span class="comment">//设置过期时间</span></span><br><span class="line">                redisTemplate.expire(lockKey, expire, TimeUnit.MILLISECONDS);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">5000</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 释放锁,支持集群和单机</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> redisTemplate</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> lockKey       锁名称</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> requestId     请求id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">boolean</span> <span class="title">unLock</span><span class="params">(RedisTemplate redisTemplate, String lockKey, String requestId)</span> </span>&#123;</span><br><span class="line">        String UNLOCK_LUA=<span class="string">"if redis.call('get', KEYS[1]) == ARGV[1] then return redis.call('del', KEYS[1]) else return 0 end"</span>;</span><br><span class="line">        List&lt;String&gt; lockKeys = Collections.singletonList(lockKey);</span><br><span class="line">        List&lt;String&gt; requestIds = Collections.singletonList(requestId);</span><br><span class="line">        RedisCallback&lt;Long&gt; callback = (RedisConnection connection) -&gt; &#123;</span><br><span class="line">            Object nativeConnection = connection.getNativeConnection();</span><br><span class="line">            <span class="comment">// 集群模式和单机模式虽然执行脚本的方法一样，但是没有共同的接口，所以只能分开执行</span></span><br><span class="line">            <span class="comment">// 集群模式</span></span><br><span class="line">            <span class="keyword">if</span> (nativeConnection <span class="keyword">instanceof</span> JedisCluster) &#123;</span><br><span class="line">                <span class="keyword">return</span> (Long) ((JedisCluster) nativeConnection).eval(UNLOCK_LUA,lockKeys, requestIds);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 单机模式</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (nativeConnection <span class="keyword">instanceof</span> Jedis) &#123;</span><br><span class="line">                <span class="keyword">return</span> (Long) ((Jedis) nativeConnection).eval(UNLOCK_LUA, lockKeys, requestIds);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0L</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">        Long result = (Long) redisTemplate.execute(callback);</span><br><span class="line">        <span class="keyword">return</span> result != <span class="keyword">null</span> &amp;&amp; result &gt; <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>一般情况上述分布式锁已经能满足很多场景了，</p><p>但是特殊情况，在 ==if (hasLock) {== 行的时候，系统挂了，那么就死锁了；</p><p>原因是加锁的地方不是原子操作。</p><p>将代码改进<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 加锁</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> redisTemplate redis连接</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> lockKey       锁名称</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> retry         从试次数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> requestId     请求id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> expire        过期时间 单位s</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">lock</span><span class="params">(RedisTemplate redisTemplate, String lockKey, Integer retry, String requestId, <span class="keyword">int</span> expire)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            RedisCallback&lt;String&gt; stringRedisCallback = <span class="keyword">new</span> RedisCallback() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> Object <span class="title">doInRedis</span><span class="params">(RedisConnection redisConnection)</span> </span>&#123;</span><br><span class="line">                    JedisCommands nativeConnection = (JedisCommands) redisConnection.getNativeConnection();</span><br><span class="line">                    <span class="keyword">return</span> nativeConnection.set(lockKey, requestId, <span class="string">"NX"</span>, <span class="string">"PX"</span>, expire);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">            String execute = (String) redisTemplate.execute(stringRedisCallback);</span><br><span class="line">            <span class="keyword">return</span> !execute.isEmpty();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">5000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        i++;</span><br><span class="line">        <span class="keyword">if</span> (i &gt; retry) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h4><p>1、锁过期了业务还没有完成怎么办？</p><p>目前只能通过对业务的测试，找到一个最大的业务执行时间，然后设置一个最大的业务执行时间。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;分布式锁其实可以理解为：控制分布式系统有序的去对共享资源进行操作，通过互斥来保持一致性。 &lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;
      
    
    </summary>
    
    
      <category term="redis" scheme="https://blog.520xnc.cn/tags/redis/"/>
    
      <category term="分布式锁" scheme="https://blog.520xnc.cn/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/"/>
    
  </entry>
  
  <entry>
    <title>谈谈自己对spring的理解</title>
    <link href="https://blog.520xnc.cn/2018/03/18/20180318095425/"/>
    <id>https://blog.520xnc.cn/2018/03/18/20180318095425/</id>
    <published>2018-03-18T01:54:25.000Z</published>
    <updated>2019-02-19T01:57:05.125Z</updated>
    
    <content type="html"><![CDATA[<h3 id="一、spring的理解"><a href="#一、spring的理解" class="headerlink" title="一、spring的理解"></a>一、spring的理解</h3><p>1、spring 是一个大概念，开始是一个library到现在的一个系列；</p><p>2、spring现在最主要的内容是spring Framework、spring data、spring security、spring Batch，快速框架 spring boot，微服务架构spring cloud，其中最主要的是springFramework，它包含了IoC、AOP、MVC以及Testing；</p><p>3、Spring 的核心就是IoC和AOP，IoC就是依赖注入，简言之就是将对象的创建交由Spring容器，由原来的编译时延迟到运行时，及是通过配置进行加载，这样一来就解决了不用编译，后期选择具体的实现，本身也是面向对象的核心理念。简言之就是从原先的new 变为配置组装，内部通过注入解决依赖关系；</p><p>4、AOP就是面向切面编程，使用最多的就是事物（动态代理，invokationHandler-jdk、MethodInterceptor-cglib ）、记录日志，自己写AOP的话就利用@aspect 和@pointcut</p><h3 id="二、Spring-最有价值的应用："><a href="#二、Spring-最有价值的应用：" class="headerlink" title="二、Spring 最有价值的应用："></a>二、Spring 最有价值的应用：</h3><p>1、Ioc和AOP就是一个套路，spring 用这个套路集成了多个orm，所以spring 越做越大，慢慢就形成了 spring way；</p><p>2、spring的实践应用，spring mvc、spring data、spring Security、Spring boot、spring cloud等</p><h3 id="三、spring-mvc的运行流程"><a href="#三、spring-mvc的运行流程" class="headerlink" title="三、spring mvc的运行流程"></a>三、spring mvc的运行流程</h3><p>1、用户发送请求到前端控制器DispatcherServlet；</p><p>2、DispatcherServlet收到请求调用HandlerMapping 处理器映射器；</p><p>3、处理器映射器通过xml配置或者注解找到对应的处理器，并生成处理器对象以及处理器拦截器（如果有），并返回给DispacherSersvlet；</p><p>4、DispacherSersvlet调用HandlerAdapter适配器；</p><p>5、HandlerAdapter 经过适配后调用具体的后端Controller；</p><p>6、Controller完成后返回ModelAndView给HandlerAdapter;</p><p>7、HandlerAdapter返回给DispatcherServlet；</p><p>8、DispatcerServlet 传递给ViewReslover视图解析器；</p><p>9、视图解析器返回View给DispatcherServlet；</p><p>10、DispatcherServlet 根据view 渲染视图，响应用户；</p><h3 id="四、Spring-data"><a href="#四、Spring-data" class="headerlink" title="四、Spring data"></a>四、Spring data</h3><p>1、包含了很多子项目，有commons，jpa，jdbc，Document、key-value等，他不拘礼与关系型数据库还是非关系型数据库，只在简化数据持久化操作，他提供了对数据库crud的操作方法，降低了数据访问对象的开发量；</p><h3 id="五、spring-Security"><a href="#五、spring-Security" class="headerlink" title="五、spring Security"></a>五、spring Security</h3><p>Spring Security是基于spring ioc和Aop为企业级应用提供安全控制的解决方案，减少企业级应用中开发大量的重复的安全代码；</p><p>1、 Web/Http 安全：这是最复杂的部分。通过建立 filter 相关的 service bean 来实现框架的认证机制</p><p>2、业务对象或者方法的安全：控制方法访问权限的。</p><p>3、AuthenticationManager：处理来自于框架其他部分的认证请求。</p><p>4、为 Web 或方法的安全提供访问决策；</p><p>5、AuthenticationProvider：AuthenticationManager 是通过它来认证用户的。</p><p>6、UserDetailsService：跟 AuthenticationProvider 关系密切，用来获取用户信息的。</p><h4 id="Shiro"><a href="#Shiro" class="headerlink" title="Shiro"></a>Shiro</h4><p>1、shiro 提供了用户认证、权限认证、session管理、加密、记住我、cache、Testing，web集成，多线程应用的并发验证；</p><p>2、shiro三大核心Subject, SecurityManager 和 Realms</p><p>spring Security和shiro的比较：<br>Shiro比Spring更容易使用，实现和最重要的理解<br>Spring Security更加知名的唯一原因是因为品牌名称<br>“Spring”以简单而闻名，但是很多人发现安装Spring Security很难<br>然而，Spring Security设置支持更好<br>Apache Shiro在Spring Security处理密码学方面有一个额外的模块<br>Spring-security 对spring 结合较好，如果项目用的springmvc ，使用起来很方便。但是如果项目中没有用到spring，那就不要考虑它了。<br>Shiro 功能强大、且 简单、灵活。是Apache 下的项目，比较可靠，且不跟任何的框架或者容器绑定，可以独立运行；</p><h3 id="六、spring-Batch"><a href="#六、spring-Batch" class="headerlink" title="六、spring Batch"></a>六、spring Batch</h3><p>1、批处理框架，大型企业应用中批量下发命令；</p><h3 id="七、spring-boot"><a href="#七、spring-boot" class="headerlink" title="七、spring boot"></a>七、spring boot</h3><p>开发目的是简化spring的配置和开发过程，框架使用了特定的配置，从而使开发人员不必在关注很多spring 模板化的配置，他致力于快速应用开发领域；</p><ol><li>创建独立的Spring应用程序</li><li>嵌入的Tomcat，无需部署WAR文件</li><li>简化Maven配置</li><li>自动配置Spring</li><li>提供生产就绪型功能，如指标，健康检查和外部配置;</li></ol><h3 id="八、spring-cloud"><a href="#八、spring-cloud" class="headerlink" title="八、spring cloud"></a>八、spring cloud</h3><p>Spring Cloud是一个基于Spring Boot来实现的一系列工具框架的集合体，Spring Cloud为开发人员提供了快速构建分布式系统中的一些通用模式（例如配置管理，服务发现，断路器，智能路由，微代理，控制总线，一次性令牌，全局锁，领导选举，分布式会话，群集状态）， 它们可以在任何分布式环境中正常工作，包括开发人员自己的笔记本电脑，裸机数据中心和受管平台；</p><p>1、 服务发现——Netflix Eureka ：一个RESTful服务，用来定位运行在AWS地区（Region）中的中间层服务。由两个组件组成：Eureka服务器和Eureka客户端；</p><p>2、客服端负载均衡——Netflix Ribbon  ：主要提供客户侧的软件负载均衡算法；</p><p>3、断路器——Netflix Hystrix： 断路器可以防止一个应用程序多次试图执行一个操作，即很  可能失败，允许它继续而不等待故障恢复或者浪费 CPU 周期，而它确定该故障是持久 的。断路器模式也使应用程序能够检测故障是否已经解决。如果问题似乎已经得到纠正​​，应用程序可以尝试调用操作；</p><p>4、 服务网关——Netflix Zuul  ：类似nginx，反向代理的功能，不过netflix自己增加了一些配合其他组件的特性；</p><p>5、 分布式配置——Spring Cloud Config；</p><p>……</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;一、spring的理解&quot;&gt;&lt;a href=&quot;#一、spring的理解&quot; class=&quot;headerlink&quot; title=&quot;一、spring的理解&quot;&gt;&lt;/a&gt;一、spring的理解&lt;/h3&gt;&lt;p&gt;1、spring 是一个大概念，开始是一个library到现在的一个
      
    
    </summary>
    
    
      <category term="spring" scheme="https://blog.520xnc.cn/tags/spring/"/>
    
      <category term="srpingboot" scheme="https://blog.520xnc.cn/tags/srpingboot/"/>
    
      <category term="springcloud" scheme="https://blog.520xnc.cn/tags/springcloud/"/>
    
  </entry>
  
  <entry>
    <title>Mybatis高级用法</title>
    <link href="https://blog.520xnc.cn/2015/04/20/20150420144522/"/>
    <id>https://blog.520xnc.cn/2015/04/20/20150420144522/</id>
    <published>2015-04-20T06:45:22.000Z</published>
    <updated>2019-02-20T07:03:00.487Z</updated>
    
    <content type="html"><![CDATA[<p>最近项目需要，研究了一下mybatis，在学习过程中记录下了其中的几个重要的用法，本文例子主要说了foreach、非空更新、插入数据时如何返回主键id， on duplicate key update的用法，其他的等有空再写吧。</p><p><strong>1、Foreach</strong><br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;delete id=<span class="string">"deleteIfNotExist"</span> parameterType=<span class="string">"java.util.List"</span>&gt;</span><br><span class="line">    DELETE  FROM bd_article_tag_map</span><br><span class="line">    WHERE article_id=#&#123;articleId&#125;</span><br><span class="line">    AND article_tag_id NOT IN</span><br><span class="line">    &lt;foreach item=<span class="string">"item"</span> index=<span class="string">"index"</span> collection=<span class="string">"list"</span> open=<span class="string">"("</span> separator=<span class="string">","</span> close=<span class="string">")"</span>&gt;</span><br><span class="line">        #&#123;item&#125;</span><br><span class="line">    &lt;/foreach&gt;</span><br><span class="line">&lt;/delete&gt;</span><br></pre></td></tr></table></figure><br><strong>2、非空更新</strong><br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;update id=<span class="string">"updateByArticleId"</span> parameterType=<span class="string">"com.iss.blog.po.Article"</span>&gt;</span><br><span class="line">    UPDATE ub_article</span><br><span class="line">    &lt;set&gt;</span><br><span class="line">        &lt;<span class="keyword">if</span> test=<span class="string">"articleTitle!=null"</span>&gt;</span><br><span class="line">            article_title =#&#123;articleTitle&#125;,</span><br><span class="line">        &lt;/if&gt;</span><br><span class="line">        &lt;<span class="keyword">if</span> test=<span class="string">"articleSummary!=null"</span>&gt;</span><br><span class="line">            article_summary=#&#123;articleSummary&#125;,</span><br><span class="line">        &lt;/if&gt;</span><br><span class="line">        &lt;<span class="keyword">if</span> test=<span class="string">"articleClick!=-1"</span>&gt;</span><br><span class="line">            article_click=#&#123;articleClick&#125;,</span><br><span class="line">        &lt;/if&gt;</span><br><span class="line">    &lt;/set&gt;</span><br><span class="line">    WHERE article_id=#&#123;articleId&#125;</span><br><span class="line">&lt;/update&gt;</span><br></pre></td></tr></table></figure><br><strong>3、插入字段后返回自增主键的值</strong><br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;insert id=<span class="string">"insert"</span> parameterType=<span class="string">"com.iss.blog.po.Article"</span> useGeneratedKeys=<span class="string">"true"</span> keyProperty=<span class="string">"article.articleId"</span>&gt;</span><br><span class="line">    INSERT INTO ub_article</span><br><span class="line">    (article_id,......</span><br><span class="line">    article_create_time,article_modify_time</span><br><span class="line">    )</span><br><span class="line">    VALUES (#&#123;article.articleId&#125;,#&#123;article.userId&#125;,......</span><br><span class="line">    #&#123;article.articleCreateTime,jdbcType=TIMESTAMP&#125;, #&#123;article.articleModifyTime,jdbcType=TIMESTAMP&#125;)</span><br><span class="line">&lt;/insert&gt;</span><br></pre></td></tr></table></figure></p><blockquote><p>设置useGeneratedKeys=”true”并且制定主键keyProperty；这样在插入成功后就会调用keyProperty的setter方法回填主键。注意，必须加上@Param，否则会报错。<br>插入成功返回成功操作的条目数；失败返回 0</p></blockquote><p><strong>4、不存在插入，存在更新</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function">INSERT INTO <span class="title">car_brand</span> <span class="params">(brand_id, initial,name ,create_time,update_time)</span></span></span><br><span class="line"><span class="function">        VALUES</span></span><br><span class="line"><span class="function">        &lt;foreach collection</span>=<span class="string">"carTypes"</span> separator=<span class="string">","</span> item=<span class="string">"item"</span>&gt;</span><br><span class="line">            (#&#123;item.id&#125;, #&#123;item.groupName&#125;,#&#123;item.name&#125;,now(),NULL)</span><br><span class="line">        &lt;/foreach&gt;</span><br><span class="line">        on duplicate key update</span><br><span class="line">        name=values(name),</span><br><span class="line">        initial=values(initial),</span><br><span class="line">        update_time=now()</span><br></pre></td></tr></table></figure></p><blockquote><p>注意关键字on duplicate key update ,其中name,initial必须有一个是唯一索引</p></blockquote>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;最近项目需要，研究了一下mybatis，在学习过程中记录下了其中的几个重要的用法，本文例子主要说了foreach、非空更新、插入数据时如何返回主键id， on duplicate key update的用法，其他的等有空再写吧。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;1、Forea
      
    
    </summary>
    
    
      <category term="mybatis" scheme="https://blog.520xnc.cn/tags/mybatis/"/>
    
  </entry>
  
  <entry>
    <title>认识javajvm以及jvm中的一些概念</title>
    <link href="https://blog.520xnc.cn/2013/08/10/20130810161455/"/>
    <id>https://blog.520xnc.cn/2013/08/10/20130810161455/</id>
    <published>2013-08-10T08:14:55.000Z</published>
    <updated>2019-02-20T08:33:48.044Z</updated>
    
    <content type="html"><![CDATA[<h4 id="一、jvm大事记"><a href="#一、jvm大事记" class="headerlink" title="一、jvm大事记"></a>一、jvm大事记</h4><blockquote><p>使用最为广泛的JVM为HotSpot</p></blockquote><p>HotSpot 为Longview Technologies开发 被SUN收购</p><p>2006年 Java开源 并建立OpenJDK</p><p>HotSpot  成为Sun JDK和OpenJDK中所带的虚拟机</p><p>2008 年 Oracle收购BEA得到JRockit VM</p><p>2010年Oracle 收购 Sun    得到Hotspot</p><p>Oracle宣布在JDK8时整合JRockit和Hotspot，优势互补,在Hotspot基础上，移植JRockit优秀特性</p><h4 id="二、jvm的启动流程"><a href="#二、jvm的启动流程" class="headerlink" title="二、jvm的启动流程"></a>二、jvm的启动流程</h4><p><img src="http://pm8ml1daf.bkt.clouddn.com/blog/jvm%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B.png" alt="Image text"><br>jvm的启动流程图</p><h4 id="三、jvm的构成"><a href="#三、jvm的构成" class="headerlink" title="三、jvm的构成"></a>三、jvm的构成</h4><blockquote><p>jvm由类加载系统，内存空间中的方法区、堆栈、本地方法栈、pc寄存器、垃圾回收器、pc寄存器、执行引擎本地方法库构成。下图是jvm的构成图</p></blockquote><p><img src="http://pm8ml1daf.bkt.clouddn.com/blog/jvm%E5%9F%BA%E6%9C%AC%E7%BB%93%E6%9E%84.png" alt="Image text"><br>jvm的构成图</p><h5 id="3-1-PC寄存器"><a href="#3-1-PC寄存器" class="headerlink" title="3.1 PC寄存器"></a>3.1 PC寄存器</h5><blockquote><p>每个线程拥有一个PC寄存器,在线程创建时 创建,指向下一条指令的地址,执行本地方法时，PC的值为undefined</p></blockquote><h5 id="3-2方法区"><a href="#3-2方法区" class="headerlink" title="3.2方法区"></a>3.2方法区</h5><blockquote><p>保存装载的类信息（类型的常量池，字段，方法信息，方法字节码），一般和永久区(Perm)关联在一起，</p></blockquote><blockquote><p>++JDK6时，String等常量信息置于方法,JDK7时，已经移动到了堆++</p></blockquote><h5 id="3-3java堆"><a href="#3-3java堆" class="headerlink" title="3.3java堆"></a>3.3java堆</h5><blockquote><p>它和程序开发密切相关，应用系统对象都保存在Java堆中，所有线程共享Java堆，对分代GC来说，堆也是分代的，它GC的主要工作区间</p></blockquote><table><thead><tr><th>eden</th><th>s0</th><th>s1</th><th>tenured  </th></tr></thead><tbody><tr><td></td></tr></tbody></table><p>上图是堆由新生代到老年代的复制算法</p><h5 id="3-4-java栈"><a href="#3-4-java栈" class="headerlink" title="3.4 java栈"></a>3.4 java栈</h5><blockquote><p>线程私有，栈由一系列帧组成（因此Java栈也叫做帧栈），帧保存一个方法的局部变量、操作数栈、常量池指针，每一次方法调用创建一个帧，并压栈。</p></blockquote><blockquote><p>栈上分配：小对象（一般几十个bytes），在没有逃逸的情况下，可以直接分配在栈上，直接分配在栈上，可以自动回收，减轻GC压力<br>大对象或者逃逸对象无法栈上分配</p></blockquote><p>问题 为了能让递归函数调用次数多些，应该怎么做？</p><blockquote><p>答案是增大栈内存</p></blockquote><h5 id="3-5java-内存模型"><a href="#3-5java-内存模型" class="headerlink" title="3.5java 内存模型"></a>3.5java 内存模型</h5><p>当数据从主内存复制到工作存储时，必须出现两个动作：第一，由主内存执行的读（read）操作；第二，由工作内存执行的相应的load操作；当数据从工作内存拷贝到主内存时，也出现两个操作：第一个，由工作内存执行的存储（store）操作；第二，由主内存执行的相应的写（write）操作</p><p><img src="http://pm8ml1daf.bkt.clouddn.com/blog/jvm%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B.png" alt="image"></p><ul><li>每一个操作都是原子的，即执行期间不会被中断</li><li>对于普通变量，一个线程中更新的值，不能马上反应在其他变量中</li><li><p>如果需要在其他线程中立即可见，需要使用 volatile 关键字</p><pre><code>volatile 关键字修饰的变量，内存模型中体现如下图</code></pre></li></ul><p><img src="http://pm8ml1daf.bkt.clouddn.com/blog/vlote.png" alt="image"></p><blockquote><p>volatile 不能代替锁,一般认为volatile 比锁性能好（不绝对）</p></blockquote><p><strong>volatile的作用</strong></p><p>1、保证变量的可见性（一个线程修改了变量，其他线程可以立即知道）;  </p><blockquote><p>保证可见性的其他方法: synchronized，final</p></blockquote><p>2、有序性</p><p>3、指令重排</p><p><strong>指令重排的基本原则</strong></p><ul><li>程序顺序原则：一个线程内保证语义的串行性</li><li>volatile规则：volatile变量的写，先发生于读</li><li>锁规则：解锁(unlock)必然发生在随后的加锁(lock)前</li><li>传递性：A先于B，B先于C 那么A必然先于C</li><li>线程的start方法先于它的每一个动作</li><li>线程的所有操作先于线程的终结（Thread.join()）</li><li>线程的中断（interrupt()）先于被中断线程的代码</li><li>对象的构造函数执行结束先于finalize()方法</li></ul><p>有写得不对的地方请大神多指教，转载请注明出处</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h4 id=&quot;一、jvm大事记&quot;&gt;&lt;a href=&quot;#一、jvm大事记&quot; class=&quot;headerlink&quot; title=&quot;一、jvm大事记&quot;&gt;&lt;/a&gt;一、jvm大事记&lt;/h4&gt;&lt;blockquote&gt;
&lt;p&gt;使用最为广泛的JVM为HotSpot&lt;/p&gt;
&lt;/blockquo
      
    
    </summary>
    
    
      <category term="jvm" scheme="https://blog.520xnc.cn/tags/jvm/"/>
    
  </entry>
  
</feed>
